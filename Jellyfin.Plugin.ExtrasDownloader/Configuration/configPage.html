<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Extras Downloader</title>
</head>
<body>
    <div id="ExtrasDownloaderConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form id="ExtrasDownloaderConfigForm">
                    <div class="folderConfigurationForm">

                        <!-- Manual Download -->
                        <h3>Download Extras for Specific Item</h3>
                        <div class="fieldDescription" style="margin-bottom: 1em;">
                            Enter a Jellyfin Item ID to download extras for a specific movie or TV series.
                            You can find the Item ID in the URL when viewing an item (e.g., /details?id=<strong>abc123...</strong>)
                        </div>

                        <div class="inputContainer" style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="inputLabel inputLabelUnfocused" for="ManualItemId">Item ID</label>
                                <input type="text" id="ManualItemId" class="emby-input" placeholder="e.g., a62451b6ecccd209c0b1897613aa9507" />
                            </div>
                            <button is="emby-button" type="button" id="btnDownloadExtras" class="raised emby-button" style="margin-bottom: 1em;">
                                <span>Download Extras</span>
                            </button>
                        </div>
                        <div id="downloadStatus" style="margin-bottom: 1em; padding: 10px; display: none;"></div>

                        <hr style="margin: 2em 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);" />

                        <!-- API Configuration -->
                        <h3>API Configuration</h3>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="TmdbApiKey">TMDB API Key (v3)</label>
                            <input type="password" id="TmdbApiKey" name="TmdbApiKey" class="emby-input" />
                            <div class="fieldDescription">
                                Get your API key from <a href="https://www.themoviedb.org/settings/api" target="_blank">TMDB</a>
                            </div>
                        </div>

                        <!-- yt-dlp Configuration -->
                        <h3>yt-dlp Configuration</h3>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="YtDlpPath">yt-dlp Path</label>
                            <input type="text" id="YtDlpPath" name="YtDlpPath" class="emby-input" />
                            <div class="fieldDescription">
                                Path to yt-dlp executable. Default: "yt-dlp" (assumes it's in PATH)
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="CookiesFilePath">Cookies File Path</label>
                            <input type="text" id="CookiesFilePath" name="CookiesFilePath" class="emby-input" />
                            <div class="fieldDescription">
                                Path to cookies.txt file for YouTube authentication (optional). Helps with age-restricted content.
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="PotProviderUrl">POT Provider URL</label>
                            <input type="text" id="PotProviderUrl" name="PotProviderUrl" class="emby-input" placeholder="http://localhost:4416" />
                            <div class="fieldDescription">
                                Proof of Origin Token provider URL for YouTube bot detection bypass (optional).
                                See <a href="https://github.com/Brainicism/bgutil-ytdlp-pot-provider" target="_blank">bgutil-ytdlp-pot-provider</a>
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="VideoFormat">Video Format</label>
                            <input type="text" id="VideoFormat" name="VideoFormat" class="emby-input" />
                            <div class="fieldDescription">
                                yt-dlp format string. Default: "bestvideo*+bestaudio/best"
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="FfmpegPath">FFmpeg Path</label>
                            <input type="text" id="FfmpegPath" name="FfmpegPath" class="emby-input" placeholder="/usr/bin/ffmpeg" />
                            <div class="fieldDescription">
                                Path to ffmpeg executable. Leave empty to use system PATH.
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ExtraYtDlpArgs">Extra yt-dlp Arguments</label>
                            <input type="text" id="ExtraYtDlpArgs" name="ExtraYtDlpArgs" class="emby-input" placeholder="--js-runtimes nodejs" />
                            <div class="fieldDescription">
                                Additional arguments to pass to yt-dlp (e.g., "--js-runtimes nodejs" for YouTube)
                            </div>
                        </div>

                        <!-- Content Types -->
                        <h3>Content Types to Download</h3>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadTrailers" />
                            <span>Trailers</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadTeasers" />
                            <span>Teasers</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadFeaturettes" />
                            <span>Featurettes</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadBehindTheScenes" />
                            <span>Behind the Scenes</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadClips" />
                            <span>Clips</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadBloopers" />
                            <span>Bloopers</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadInterviews" />
                            <span>Interviews</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="DownloadShorts" />
                            <span>Shorts</span>
                        </label>

                        <!-- Filtering Options -->
                        <h3>Filtering Options</h3>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MaxVideosPerType">Max Videos Per Type</label>
                            <input type="number" id="MaxVideosPerType" name="MaxVideosPerType" min="1" max="10" class="emby-input" />
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="PreferredLanguages">Preferred Languages</label>
                            <input type="text" id="PreferredLanguages" name="PreferredLanguages" class="emby-input" placeholder="en-US,de-DE" />
                            <div class="fieldDescription">Comma-separated language codes (e.g., "en-US,de-DE")</div>
                        </div>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="PreferOfficialVideos" />
                            <span>Prefer Official Videos</span>
                        </label>
                        <div class="fieldDescription">Sort official videos first when multiple are available</div>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="OfficialVideosOnly" />
                            <span>Official Videos Only</span>
                        </label>
                        <div class="fieldDescription">Skip unofficial/fan uploads entirely</div>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="SkipExistingExtras" />
                            <span>Skip Items With Existing Extras</span>
                        </label>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="OnlyMissingTrailers" />
                            <span>Only Process Items Missing Trailers</span>
                        </label>

                        <!-- Output Configuration -->
                        <h3>Output Configuration</h3>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="OrganizeIntoFolders" />
                            <span>Organize Into Subfolders</span>
                        </label>
                        <div class="fieldDescription">Use Plex-compatible folder structure (Trailers, Featurettes, etc.)</div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="OutputFormat">Output Format</label>
                            <select id="OutputFormat" name="OutputFormat" class="emby-select">
                                <option value="mkv">MKV</option>
                                <option value="mp4">MP4</option>
                                <option value="webm">WebM</option>
                            </select>
                        </div>

                        <label class="checkboxContainer">
                            <input is="emby-checkbox" type="checkbox" id="EmbedSubtitles" />
                            <span>Embed Subtitles</span>
                        </label>

                        <!-- Rate Limiting -->
                        <h3>Rate Limiting</h3>
                        <div class="fieldDescription" style="margin-bottom: 1em;">
                            These settings help avoid being blocked by YouTube. Higher values are safer but slower.
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="SleepBetweenVideos">Sleep Between Videos (seconds)</label>
                            <input type="number" id="SleepBetweenVideos" name="SleepBetweenVideos" min="0" max="600" class="emby-input" />
                            <div class="fieldDescription">Wait time after downloading each video</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="SleepBetweenItems">Sleep Between Items (seconds)</label>
                            <input type="number" id="SleepBetweenItems" name="SleepBetweenItems" min="0" max="1800" class="emby-input" />
                            <div class="fieldDescription">Wait time after processing each movie/show</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="YtDlpSleepInterval">yt-dlp Min Sleep (seconds)</label>
                            <input type="number" id="YtDlpSleepInterval" name="YtDlpSleepInterval" min="0" max="300" class="emby-input" />
                            <div class="fieldDescription">Minimum sleep between yt-dlp requests</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="YtDlpMaxSleepInterval">yt-dlp Max Sleep (seconds)</label>
                            <input type="number" id="YtDlpMaxSleepInterval" name="YtDlpMaxSleepInterval" min="0" max="600" class="emby-input" />
                            <div class="fieldDescription">Maximum sleep between yt-dlp requests (randomized)</div>
                        </div>

                        <!-- Tracking -->
                        <h3>Tracking</h3>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="ProcessedItemRetentionDays">Processed Item Retention (days)</label>
                            <input type="number" id="ProcessedItemRetentionDays" name="ProcessedItemRetentionDays" min="1" max="365" class="emby-input" />
                            <div class="fieldDescription">Re-check items after this many days</div>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var ExtrasDownloaderConfig = {
                pluginUniqueId: 'd2a0abca-4598-4d40-97bc-f74966738645'
            };

            document.querySelector('#ExtrasDownloaderConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(ExtrasDownloaderConfig.pluginUniqueId).then(function(config) {
                        // API
                        document.querySelector('#TmdbApiKey').value = config.TmdbApiKey || '';

                        // yt-dlp
                        document.querySelector('#YtDlpPath').value = config.YtDlpPath || 'yt-dlp';
                        document.querySelector('#CookiesFilePath').value = config.CookiesFilePath || '';
                        document.querySelector('#PotProviderUrl').value = config.PotProviderUrl || '';
                        document.querySelector('#VideoFormat').value = config.VideoFormat || 'bestvideo*+bestaudio/best';
                        document.querySelector('#FfmpegPath').value = config.FfmpegPath || '';
                        document.querySelector('#ExtraYtDlpArgs').value = config.ExtraYtDlpArgs || '';

                        // Content Types
                        document.querySelector('#DownloadTrailers').checked = config.DownloadTrailers;
                        document.querySelector('#DownloadTeasers').checked = config.DownloadTeasers;
                        document.querySelector('#DownloadFeaturettes').checked = config.DownloadFeaturettes;
                        document.querySelector('#DownloadBehindTheScenes').checked = config.DownloadBehindTheScenes;
                        document.querySelector('#DownloadClips').checked = config.DownloadClips;
                        document.querySelector('#DownloadBloopers').checked = config.DownloadBloopers;
                        document.querySelector('#DownloadInterviews').checked = config.DownloadInterviews;
                        document.querySelector('#DownloadShorts').checked = config.DownloadShorts;

                        // Filtering
                        document.querySelector('#MaxVideosPerType').value = config.MaxVideosPerType || 3;
                        document.querySelector('#PreferredLanguages').value = config.PreferredLanguages || 'en-US';
                        document.querySelector('#PreferOfficialVideos').checked = config.PreferOfficialVideos;
                        document.querySelector('#OfficialVideosOnly').checked = config.OfficialVideosOnly;
                        document.querySelector('#SkipExistingExtras').checked = config.SkipExistingExtras;
                        document.querySelector('#OnlyMissingTrailers').checked = config.OnlyMissingTrailers;

                        // Output
                        document.querySelector('#OrganizeIntoFolders').checked = config.OrganizeIntoFolders;
                        document.querySelector('#OutputFormat').value = config.OutputFormat || 'mkv';
                        document.querySelector('#EmbedSubtitles').checked = config.EmbedSubtitles;

                        // Rate Limiting
                        document.querySelector('#SleepBetweenVideos').value = config.SleepBetweenVideos || 60;
                        document.querySelector('#SleepBetweenItems').value = config.SleepBetweenItems || 300;
                        document.querySelector('#YtDlpSleepInterval').value = config.YtDlpSleepInterval || 30;
                        document.querySelector('#YtDlpMaxSleepInterval').value = config.YtDlpMaxSleepInterval || 120;

                        // Tracking
                        document.querySelector('#ProcessedItemRetentionDays').value = config.ProcessedItemRetentionDays || 7;

                        Dashboard.hideLoadingMsg();
                    });
                });

            // Manual download button handler
            document.querySelector('#btnDownloadExtras')
                .addEventListener('click', function() {
                    var itemId = document.querySelector('#ManualItemId').value.trim();
                    var statusDiv = document.querySelector('#downloadStatus');

                    if (!itemId) {
                        statusDiv.style.display = 'block';
                        statusDiv.style.backgroundColor = 'rgba(255, 100, 100, 0.2)';
                        statusDiv.textContent = 'Please enter an Item ID';
                        return;
                    }

                    statusDiv.style.display = 'block';
                    statusDiv.style.backgroundColor = 'rgba(100, 100, 255, 0.2)';
                    statusDiv.textContent = 'Queuing download...';

                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('ExtrasDownloader/Download/' + itemId),
                        dataType: 'json'
                    }).then(function(response) {
                        if (response.Success) {
                            statusDiv.style.backgroundColor = 'rgba(100, 255, 100, 0.2)';
                            statusDiv.textContent = response.Message + ' (TMDB ID: ' + response.TmdbId + ')';
                            document.querySelector('#ManualItemId').value = '';
                        } else {
                            statusDiv.style.backgroundColor = 'rgba(255, 100, 100, 0.2)';
                            statusDiv.textContent = 'Error: ' + response.Message;
                        }
                    }).catch(function(error) {
                        statusDiv.style.backgroundColor = 'rgba(255, 100, 100, 0.2)';
                        var errorMsg = 'Failed to queue download';
                        if (error.status === 404) {
                            errorMsg = 'Item not found. Check the Item ID.';
                        } else if (error.status === 400) {
                            errorMsg = error.responseJSON ? error.responseJSON.Message : 'Invalid item type or missing TMDB ID';
                        }
                        statusDiv.textContent = errorMsg;
                    });
                });

            document.querySelector('#ExtrasDownloaderConfigForm')
                .addEventListener('submit', function(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(ExtrasDownloaderConfig.pluginUniqueId).then(function(config) {
                        // API
                        config.TmdbApiKey = document.querySelector('#TmdbApiKey').value;

                        // yt-dlp
                        config.YtDlpPath = document.querySelector('#YtDlpPath').value;
                        config.CookiesFilePath = document.querySelector('#CookiesFilePath').value;
                        config.PotProviderUrl = document.querySelector('#PotProviderUrl').value;
                        config.VideoFormat = document.querySelector('#VideoFormat').value;
                        config.FfmpegPath = document.querySelector('#FfmpegPath').value;
                        config.ExtraYtDlpArgs = document.querySelector('#ExtraYtDlpArgs').value;

                        // Content Types
                        config.DownloadTrailers = document.querySelector('#DownloadTrailers').checked;
                        config.DownloadTeasers = document.querySelector('#DownloadTeasers').checked;
                        config.DownloadFeaturettes = document.querySelector('#DownloadFeaturettes').checked;
                        config.DownloadBehindTheScenes = document.querySelector('#DownloadBehindTheScenes').checked;
                        config.DownloadClips = document.querySelector('#DownloadClips').checked;
                        config.DownloadBloopers = document.querySelector('#DownloadBloopers').checked;
                        config.DownloadInterviews = document.querySelector('#DownloadInterviews').checked;
                        config.DownloadShorts = document.querySelector('#DownloadShorts').checked;

                        // Filtering
                        config.MaxVideosPerType = parseInt(document.querySelector('#MaxVideosPerType').value, 10);
                        config.PreferredLanguages = document.querySelector('#PreferredLanguages').value;
                        config.PreferOfficialVideos = document.querySelector('#PreferOfficialVideos').checked;
                        config.OfficialVideosOnly = document.querySelector('#OfficialVideosOnly').checked;
                        config.SkipExistingExtras = document.querySelector('#SkipExistingExtras').checked;
                        config.OnlyMissingTrailers = document.querySelector('#OnlyMissingTrailers').checked;

                        // Output
                        config.OrganizeIntoFolders = document.querySelector('#OrganizeIntoFolders').checked;
                        config.OutputFormat = document.querySelector('#OutputFormat').value;
                        config.EmbedSubtitles = document.querySelector('#EmbedSubtitles').checked;

                        // Rate Limiting
                        config.SleepBetweenVideos = parseInt(document.querySelector('#SleepBetweenVideos').value, 10);
                        config.SleepBetweenItems = parseInt(document.querySelector('#SleepBetweenItems').value, 10);
                        config.YtDlpSleepInterval = parseInt(document.querySelector('#YtDlpSleepInterval').value, 10);
                        config.YtDlpMaxSleepInterval = parseInt(document.querySelector('#YtDlpMaxSleepInterval').value, 10);

                        // Tracking
                        config.ProcessedItemRetentionDays = parseInt(document.querySelector('#ProcessedItemRetentionDays').value, 10);

                        ApiClient.updatePluginConfiguration(ExtrasDownloaderConfig.pluginUniqueId, config).then(function() {
                            Dashboard.processPluginConfigurationUpdateResult();
                        });
                    });
                    return false;
                });
        </script>
    </div>
</body>
</html>
